<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITC Event Manager</title>
    <link rel="stylesheet" href="/studentStyles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="NITC.png">
</head>
<body>
    <div id="shutter-window" class="shutter-window"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-left">
            <span class="navbar-text"><h1>NITC Event Manager</h1></span>
        </div>
        <ul class="navbar-links">
            <li><a href="#" class="navbutton" id="profileLink" onclick="profileRedirect(event)">Profile</a></li>
            <li><a href="/logout" class="navbutton">Logout</a></li>
            <li><p class="navbutton" style="background: #FF416C; border: 2px solid #FFF; color:#FFF;">Student</p></li>
        </ul>
    </nav>

    <div style="padding-top: 30px;">
        <main>
            <!-- Upcoming Events Section -->
            <div class="sect">
                <div style="display: flex; justify-content: space-between;">
                    <h1>Upcoming Events</h1>
                    <select id="categoryupcoming" name="cat">
                        <option value="all" selected>All</option>
                        <option value="workshop">Workshop</option>
                        <option value="hackathon">Hackathon</option>
                        <option value="cultural_event">Cultural Event</option>
                        <option value="contest">Contest</option>
                    </select>
                    <button class="navbutton" onclick="fetchEvents('upcoming')" style="padding: 15px; margin: 30px;">Filter</button>
                </div>
                <section class="cards-section" id="upcoming-events"></section>
            </div>

            <!-- Ongoing Events Section -->
            <div class="sect">
                <div style="display: flex; justify-content: space-between;">
                    <h1>Ongoing Events</h1>
                    <select id="categoryongoing" name="cat">
                        <option value="all" selected>All</option>
                        <option value="workshop">Workshop</option>
                        <option value="hackathon">Hackathon</option>
                        <option value="cultural_event">Cultural Event</option>
                        <option value="contest">Contest</option>
                    </select>
                    <button class="navbutton" onclick="fetchEvents('ongoing')" style="padding: 15px; margin: 30px;">Filter</button>
                </div>
                <section class="cards-section" id="ongoing-events"></section>
            </div>

            <!-- Modal -->
            <div class="modal" id="detailsModal">
                <div class="modal-content">
                    <h3 id="modalTitle">Modal Title</h3>
                    <p id="modalDescription">Modal Description</p>
                    <button class="close-btn" onclick="closeModal()">Close</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Go to Top Button -->
    <button id="goToTopBtn" onclick="scrollToTop()">Go to Top</button>
    <script src="/scripts.js"></script>
</body>
</html>
<script>

// Scroll to top
const goToTopBtn = document.getElementById("goToTopBtn");
window.onscroll = function () {
    goToTopBtn.style.display = document.documentElement.scrollTop > 20 ? "block" : "none";
};
function scrollToTop() {
    window.scrollTo({ top: 0, behavior: "smooth" });
}

// Redirect to profile
async function profileRedirect(event) {
    event.preventDefault();
    try {
        console.log('Checking token...');
        const response = await fetch('/api/auth/check-token', {
            method: 'GET',
            credentials: 'include' // Include cookies in the request
        });

        if (response.ok) {
            console.log('Token is valid. Redirecting to profile...');
            window.location.href = "/home/student/profile";
        } else {
            console.log('Token is invalid. Please log in.');
            alert("Please log in to access your profile.");
        }
    } catch (error) {
        console.error("Error checking token:", error);
        alert("An error occurred. Please try again.");
    }
}

// Fetch events dynamically
async function fetchEvents(type) {
    const category = document.getElementById(`category${type}`).value;
    const eventsContainer = document.getElementById(`${type}-events`);
    eventsContainer.innerHTML = "Loading...";

    try {
        const response = await fetch(`/api/events/${type}-events`);
        const events = await response.json();

        if (!Array.isArray(events)) {
            console.error("Invalid events data:", events);
            eventsContainer.innerHTML = "No events found.";
            return;
        }

        eventsContainer.innerHTML = "";
        events.forEach(event => {
            if (category === "all" || event.category === category) {
                let disc;
                if (event.description.length > 30) {
                    disc = event.description.slice(0, 27) + "...";
                } else {
                    disc = event.description;
                }
                const eventCard = document.createElement("div");
                eventCard.className = "event-card";
                eventCard.innerHTML = `
                    <h2>${event.name}</h2>
                    <p>${disc}</p>
                    <p>Date: ${new Date(event.date).toLocaleDateString()}</p>
                    <p>From: ${event.stime}</p>
                    <p>To: ${event.etime}</p>
                    <p>Venue: ${event.venue}</p>
                    <button class="button" onclick="registerForEvent('${event._id}')">Register</button>
                    <button class="button" onclick="showDetails('${event.name}', '${event.description}')">More</button>
                `;
                eventsContainer.appendChild(eventCard);
            }
        });
    } catch (error) {
        console.error("Error fetching events:", error);
        eventsContainer.innerHTML = "Failed to load events.";
    }
}

// Show modal with event details
function showDetails(title, description) {
    document.getElementById("modalTitle").textContent = title;
    document.getElementById("modalDescription").textContent = description;
    document.getElementById("detailsModal").style.display = "flex";
}
function closeModal() {
    document.getElementById("detailsModal").style.display = "none";
}

// Register for an event
async function registerForEvent(eventId) {
    try {
        const response = await fetch(`/api/events/register/${eventId}`, {
            method: "POST",
            credentials: 'include', // Include cookies in the request
            headers: {
                "Content-Type": "application/json",
            }
        });
        const result = await response.json();

        if (response.ok) {
            alert(result.message);
        } else {
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error("Error registering for event:", error);
        alert("An error occurred while registering.");
    }
}

// Fetch events on page load
fetchEvents("upcoming");
fetchEvents("ongoing");

</script>