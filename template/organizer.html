<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITC Event Manager</title>
    <link rel="stylesheet" href="/organizerstyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="NITC.png">
</head>
<body>
    <!-- Navbar -->
    <div>
        <nav class="navbar">
            <div class="navbar-left">
                <!-- <img src="NITC.png" alt="Student Avatar" class="navbar-avatar"> -->
                <span class="navbar-text"><h1>NITC Event Manager</h1></span>
            </div>
            <ul class="navbar-links">
                <li><a href="/home/organizer/addevent" class="navbutton">Add Event</a></li>
                <!-- <li><a href="/profile/organizer" class="navbutton">Profile</a></li> -->
    
                <div class="dropdown">
                    <li><a href="#" class="navbutton" class="dropdown-link">Profile</a></li>
                    <!-- <a href="#" class="">Open Dropdown</a> -->
                    <div class="dropdown-content">
                      <p id="profname">Name</p>
                      <p id="profemail">email</p>
                    </div>
                  </div>
    
                <li><a href="/logout" class="navbutton">Logout</a></li>
                <li><p class="navbutton" style="background: #FF416C; border: 2px solid #FFF; color:#FFF;">Organizer</p></li>
                <!-- <li><a href="#">Services</a></li>
                <li><a href="#">Contact</a></li> -->
            </ul>
        </nav>
    </div>

    <div style="padding-top: 30px;">
        <main>
            <div class="sect">
                <div style="display: flex; justify-content: space-between;">
                    <h1>Organized Events</h1>
                    <select id="category" name="cat" required>
                        <option value="all" disabled selected hidden>All</option>
                        <option value="workshop">Workshop</option>
                        <option value="hackathon">Hackathon</option>
                        <option value="cultural_event">Cultural Event</option>
                        <option value="contest">Contest</option>
                    </select>
                    <button class="navbutton" style="padding: 15px; margin: 30px; font-size: small;">Filter</button>
                </div>

                <!-- Card Section -->
                <section class="cards-section" id="organized-events">
                    <!-- Events will be dynamically inserted here -->
                </section>
                <div class="modal" id="detailsModal">
                    <div class="modal-content">
                        <h3 id="modalTitle">Modal Title</h3>
                        <p id="modalDescription">Modal Description</p>
                        <button class="close-btn" onclick="closeModal()">Close</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Go to Top Button -->
    <button id="goToTopBtn" onclick="scrollToTop()">Go to Top</button>

    <script>
        // Scroll to Top Button
        let mybutton = document.getElementById("goToTopBtn");

        window.onscroll = function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                mybutton.style.display = "block";
            } else {
                mybutton.style.display = "none";
            }
        };

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Function to fetch and display events organized by the logged-in organizer
        async function fetchOrganizedEvents() {
            console.log('fetchOrganizedEvents called'); // Debugging log
            try {
                const tokenResponse = await fetch('/api/auth/check-token', {
                    method: 'GET',
                    credentials: 'include' // Include cookies in the request
                });

                if (!tokenResponse.ok) {
                    console.error('Token is invalid. Please log in.');
                    return;
                }

                const cat = document.getElementById('category').value;

                const response = await fetch('/api/events/organized-events', {
                    credentials: 'include', // Include cookies in the request
                    headers: {
                        "Content-Type": "application/json",
                    }
                });

                console.log('Response received:', response); // Debugging log
                const events = await response.json();
                console.log('Events fetched:', events); // Debugging log

                const eventsContainer = document.getElementById('organized-events');
                eventsContainer.innerHTML = '';

                if (Array.isArray(events)) {
                    events.forEach(event => {
                        if (event.category == cat || cat == "all"){
                            let disc;
                            if (event.description.length > 30){
                                disc = event.description.slice(0, 27) + "...";
                            }
                            else{
                                disc = event.description;
                            }
                            const eventCard = document.createElement('div');
                            eventCard.className = 'event-card';
                            eventCard.id = event._id;
                            eventCard.innerHTML = `
                                <h2>${event.name}</h2>
                                <p>${disc}</p>
                                <p class="date">Date: ${new Date(event.date).toLocaleDateString()}</p>
                                <p class="date">From: ${event.stime}</p>
                                <p class="date">To: ${event.etime}</p>
                                <p class="date">At: ${event.venue}</p>
                                <a href="#" class="button" onclick="showDetails('${event.name}', '${event.description}')" id="${event._id}">More Info</a>
                                <a href="/participants?id=${event._id}" class="button" id="${event._id}">Registrants</a>
                            `;
                            eventsContainer.appendChild(eventCard);
                        }
                    });
                } else {
                    console.error('Expected an array but got:', events);
                }
            } catch (error) {
                console.error('Error fetching organized events:', error);
            }
        }

        // Fetch organized events on page load
        window.onload = () => {
            console.log('Window loaded'); // Debugging log
            fetchOrganizedEvents();
        };
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const tokenResponse = await fetch('/api/auth/check-token', {
                method: 'GET',
                credentials: 'include' // Include cookies in the request
            });

            if (!tokenResponse.ok) {
                console.error('Token is invalid. Please log in.');
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include' // Include cookies in the request
                });
                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('profname').textContent = userData.name || 'Unnamed';
                    document.getElementById('profemail').textContent = userData.email || 'No Email Provided';
                } else {
                    console.error('Failed to fetch user info');
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
            }
        });
    </script>
    <script>
        // Show modal with details
        function showDetails(title, description) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalDescription').textContent = description;
            document.getElementById('detailsModal').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }
    </script>
</body>
</html>